(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=e(s);fetch(s.href,a)}})();class E{state;constructor(t){this.state=t}getSeed(){return this.state}setSeed(t){this.state=t}random(){let t=this.state+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}randomInt(t){return Math.floor(this.random()*t)}static generateSeed(){return Date.now()^Math.random()*4294967295}}const b={speed_boost:{color:"#00ffff",glowColor:"#00bfff",duration:5e3,pointsBonus:5,displayName:"Speed Boost"},slow_motion:{color:"#ff00ff",glowColor:"#ff69b4",duration:5e3,pointsBonus:5,displayName:"Slow Motion"},bonus_points:{color:"#ffd700",glowColor:"#ffaa00",duration:0,pointsBonus:50,displayName:"Bonus Points"},invincibility:{color:"#ffffff",glowColor:"#f0f0f0",duration:3e3,pointsBonus:10,displayName:"Invincibility"}},st=.12,V=7e3;class ${x=0;y=0;type;gridWidth;gridHeight;isActive=!1;spawnTime=0;animationPhase=0;rng=null;constructor(t,e){this.gridWidth=t,this.gridHeight=e,this.type="bonus_points"}setRng(t){this.rng=t}getConfig(){return{type:this.type,...b[this.type]}}shouldSpawn(){return(this.rng?this.rng.random():Math.random())<st}spawn(t,e,i){if(this.isActive)return!1;const s=Object.keys(b),a=this.rng?this.rng.randomInt(s.length):Math.floor(Math.random()*s.length);this.type=s[a];let n=0;const r=100;for(;n<r;){this.randomize();const l=t.some(d=>d.x===this.x&&d.y===this.y),c=this.x===e&&this.y===i;if(!l&&!c)return this.isActive=!0,this.spawnTime=performance.now(),this.animationPhase=0,!0;n++}return!1}randomize(){if(this.rng){this.x=this.rng.randomInt(this.gridWidth),this.y=this.rng.randomInt(this.gridHeight);return}this.x=Math.floor(Math.random()*this.gridWidth),this.y=Math.floor(Math.random()*this.gridHeight)}update(t){return this.isActive?(this.animationPhase=(t-this.spawnTime)%1e3,t-this.spawnTime>=V?(this.despawn(),!1):!0):!1}despawn(){this.isActive=!1}getRemainingTime(t){return this.isActive?Math.max(0,V-(t-this.spawnTime)):0}}const at=1,C=5,nt=3,rt=6,ot=2;class ht{ctx;width;height;gridSize;colors;thickness=nt;constructor(t,e,i){this.ctx=t.getContext("2d"),this.width=t.width,this.height=t.height,this.gridSize=e,this.colors=i}setTheme(t){this.colors=t}setThickness(t){this.thickness=Math.max(at,Math.min(C,t))}clear(){this.ctx.fillStyle=this.colors.canvasBg,this.ctx.fillRect(0,0,this.width,this.height),this.ctx.strokeStyle=this.colors.gridColor,this.ctx.lineWidth=1;for(let t=0;t<=this.width;t+=this.gridSize)this.ctx.beginPath(),this.ctx.moveTo(t,0),this.ctx.lineTo(t,this.height),this.ctx.stroke();for(let t=0;t<=this.height;t+=this.gridSize)this.ctx.beginPath(),this.ctx.moveTo(0,t),this.ctx.lineTo(this.width,t),this.ctx.stroke()}drawSnake(t,e=!1){const i=rt-this.thickness;t.forEach((s,a)=>{const n=a===0,r=this.ctx.createLinearGradient(s.x*this.gridSize,s.y*this.gridSize,(s.x+1)*this.gridSize,(s.y+1)*this.gridSize);n?(r.addColorStop(0,this.colors.snakeHeadStart),r.addColorStop(1,this.colors.snakeHeadEnd)):(r.addColorStop(0,this.colors.snakeBodyStart),r.addColorStop(1,this.colors.snakeBodyEnd)),e&&(this.ctx.shadowBlur=15,this.ctx.shadowColor="#ffffff"),this.ctx.fillStyle=r;const c=Math.max(ot,(n?6:4)-(C-this.thickness));if(this.roundRect(s.x*this.gridSize+i,s.y*this.gridSize+i,this.gridSize-i*2,this.gridSize-i*2,c),this.ctx.fill(),e&&(this.ctx.shadowBlur=0),n){const d=this.thickness/C,u=Math.max(1,2*d);this.ctx.fillStyle="#fff",this.ctx.beginPath(),this.ctx.arc(s.x*this.gridSize+this.gridSize*.3,s.y*this.gridSize+this.gridSize*.3,u,0,Math.PI*2),this.ctx.arc(s.x*this.gridSize+this.gridSize*.7,s.y*this.gridSize+this.gridSize*.3,u,0,Math.PI*2),this.ctx.fill()}})}drawFood(t,e){this.ctx.shadowBlur=15,this.ctx.shadowColor=this.colors.foodGlow,this.ctx.fillStyle=this.colors.foodColor,this.ctx.beginPath(),this.ctx.arc(t*this.gridSize+this.gridSize/2,e*this.gridSize+this.gridSize/2,this.gridSize/2-2,0,Math.PI*2),this.ctx.fill(),this.ctx.shadowBlur=0}drawSpecialFood(t,e,i,s){const a=b[i],n=t*this.gridSize+this.gridSize/2,r=e*this.gridSize+this.gridSize/2,l=.85+.15*Math.sin(s*Math.PI*2/1e3),c=(this.gridSize/2-2)*l;this.ctx.shadowBlur=20+10*Math.sin(s*Math.PI*2/1e3),this.ctx.shadowColor=a.glowColor,this.ctx.fillStyle=a.color,this.ctx.beginPath(),this.ctx.arc(n,r,c,0,Math.PI*2),this.ctx.fill(),this.ctx.shadowBlur=0;const d=this.ctx.createRadialGradient(n-c*.3,r-c*.3,0,n,r,c);d.addColorStop(0,"rgba(255, 255, 255, 0.5)"),d.addColorStop(.5,"rgba(255, 255, 255, 0.1)"),d.addColorStop(1,"rgba(255, 255, 255, 0)"),this.ctx.fillStyle=d,this.ctx.beginPath(),this.ctx.arc(n,r,c,0,Math.PI*2),this.ctx.fill(),this.drawPowerUpIcon(n,r,c*.5,i),this.ctx.shadowBlur=0}drawPowerUpIcon(t,e,i,s){switch(this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.strokeStyle="rgba(0, 0, 0, 0.5)",this.ctx.lineWidth=2,s){case"speed_boost":this.ctx.beginPath(),this.ctx.moveTo(t+i*.1,e-i*.7),this.ctx.lineTo(t-i*.3,e+i*.1),this.ctx.lineTo(t+i*.1,e+i*.1),this.ctx.lineTo(t-i*.1,e+i*.7),this.ctx.lineTo(t+i*.3,e-i*.1),this.ctx.lineTo(t-i*.1,e-i*.1),this.ctx.closePath(),this.ctx.fill();break;case"slow_motion":this.ctx.beginPath(),this.ctx.moveTo(t-i*.4,e-i*.6),this.ctx.lineTo(t+i*.4,e-i*.6),this.ctx.lineTo(t,e),this.ctx.lineTo(t+i*.4,e+i*.6),this.ctx.lineTo(t-i*.4,e+i*.6),this.ctx.lineTo(t,e),this.ctx.closePath(),this.ctx.fill();break;case"bonus_points":this.drawStar(t,e,5,i*.7,i*.35);break;case"invincibility":this.ctx.beginPath(),this.ctx.moveTo(t,e-i*.6),this.ctx.lineTo(t+i*.5,e-i*.3),this.ctx.lineTo(t+i*.5,e+i*.1),this.ctx.quadraticCurveTo(t,e+i*.8,t,e+i*.8),this.ctx.quadraticCurveTo(t,e+i*.8,t-i*.5,e+i*.1),this.ctx.lineTo(t-i*.5,e-i*.3),this.ctx.closePath(),this.ctx.fill();break}}drawStar(t,e,i,s,a){let n=Math.PI/2*3,r=t,l=e;const c=Math.PI/i;this.ctx.beginPath(),this.ctx.moveTo(t,e-s);for(let d=0;d<i;d++)r=t+Math.cos(n)*s,l=e+Math.sin(n)*s,this.ctx.lineTo(r,l),n+=c,r=t+Math.cos(n)*a,l=e+Math.sin(n)*a,this.ctx.lineTo(r,l),n+=c;this.ctx.lineTo(t,e-s),this.ctx.closePath(),this.ctx.fill()}drawObstacles(t){t.forEach(i=>{let s;switch(i.type){case"static":s=this.colors.obstacleStatic;break;case"moving":s=this.colors.obstacleMoving;break;case"temporary":s=this.colors.obstacleTemporary;break;default:{const a=i.type;s=this.colors.obstacleStatic,console.warn(`Unknown obstacle type: ${a}`)}}if(this.ctx.fillStyle=s,i.type==="static")this.roundRect(i.x*this.gridSize+2,i.y*this.gridSize+2,this.gridSize-4,this.gridSize-4,3),this.ctx.fill();else if(i.type==="moving"){const a=i.x*this.gridSize+this.gridSize/2,n=i.y*this.gridSize+this.gridSize/2,r=this.gridSize/2-2;this.ctx.beginPath(),this.ctx.moveTo(a,n-r),this.ctx.lineTo(a+r,n),this.ctx.lineTo(a,n+r),this.ctx.lineTo(a-r,n),this.ctx.closePath(),this.ctx.fill()}else{const a=i.x*this.gridSize+this.gridSize/2,n=i.y*this.gridSize+this.gridSize/2,r=this.gridSize/2-2;this.ctx.beginPath(),this.ctx.moveTo(a,n-r),this.ctx.lineTo(a+r,n+r),this.ctx.lineTo(a-r,n+r),this.ctx.closePath(),this.ctx.fill()}})}roundRect(t,e,i,s,a){i<2*a&&(a=i/2),s<2*a&&(a=s/2),this.ctx.beginPath(),this.ctx.moveTo(t+a,e),this.ctx.arcTo(t+i,e,t+i,e+s,a),this.ctx.arcTo(t+i,e+s,t,e+s,a),this.ctx.arcTo(t,e+s,t,e,a),this.ctx.arcTo(t,e,t+i,e,a),this.ctx.closePath()}}class z{segments;direction;nextDirection;gridWidth;gridHeight;growing=!1;constructor(t,e){this.gridWidth=t,this.gridHeight=e,this.segments=[{x:5,y:5},{x:4,y:5},{x:3,y:5}],this.direction={x:1,y:0},this.nextDirection={x:1,y:0}}setDirection(t){return this.direction.x+t.x===0&&this.direction.y+t.y===0?!1:(this.nextDirection=t,!0)}move(){this.direction=this.nextDirection;const t=this.segments[0],e={x:t.x+this.direction.x,y:t.y+this.direction.y};this.segments.unshift(e),this.growing?this.growing=!1:this.segments.pop()}grow(){this.growing=!0}checkCollision(){const t=this.segments[0];if(t.x<0||t.x>=this.gridWidth||t.y<0||t.y>=this.gridHeight)return!0;for(let e=1;e<this.segments.length;e++)if(t.x===this.segments[e].x&&t.y===this.segments[e].y)return!0;return!1}get head(){return this.segments[0]}}class G{x;y;gridWidth;gridHeight;rng=null;constructor(t,e){this.gridWidth=t,this.gridHeight=e,this.x=0,this.y=0,this.randomize()}setRng(t){this.rng=t}clearRng(){this.rng=null}randomize(){this.rng?(this.x=this.rng.randomInt(this.gridWidth),this.y=this.rng.randomInt(this.gridHeight)):(this.x=Math.floor(Math.random()*this.gridWidth),this.y=Math.floor(Math.random()*this.gridHeight))}respawn(t,e=[]){let i=!1;for(;!i;){this.randomize();const s=t.some(n=>n.x===this.x&&n.y===this.y),a=e.some(n=>n.x===this.x&&n.y===this.y);i=!s&&!a}}}class K{snake;food;specialFood;gridWidth=0;gridHeight=0;obstaclePositions=[];constructor(t,e,i,s,a){this.snake=t,this.food=e,this.specialFood=a||null,this.updateBounds(i,s)}updateBounds(t,e){this.gridWidth=t,this.gridHeight=e}setObstacles(t){this.obstaclePositions=t}getNextMove(){const t=this.snake.head,e={x:this.food.x,y:this.food.y},i=this.snake.segments,s=this.createGrid(i);let a=e;if(this.specialFood?.isActive){const l={x:this.specialFood.x,y:this.specialFood.y},c=this.bfs(t,l,s);if(c&&c.length>0){const d=c.length,u=performance.now(),m=this.specialFood.getRemainingTime(u);d*120<m*.8&&(a=l)}}const n=this.bfs(t,a,s);if(n&&n.length>0)return this.directionToVector(this.getDirection(t,n[0]));const r=this.getValidMoves(t,s);return r.length>0?this.directionToVector(this.getDirection(t,r[0])):{x:0,y:-1}}directionToVector(t){switch(t){case"UP":return{x:0,y:-1};case"DOWN":return{x:0,y:1};case"LEFT":return{x:-1,y:0};case"RIGHT":return{x:1,y:0}}}createGrid(t){const e=[];for(let i=0;i<this.gridWidth;i++){e[i]=[];for(let s=0;s<this.gridHeight;s++)e[i][s]=!0}for(let i=0;i<t.length-1;i++){const s=t[i];s.x>=0&&s.x<this.gridWidth&&s.y>=0&&s.y<this.gridHeight&&(e[s.x][s.y]=!1)}for(const i of this.obstaclePositions)i.x>=0&&i.x<this.gridWidth&&i.y>=0&&i.y<this.gridHeight&&(e[i.x][i.y]=!1);return e}bfs(t,e,i){const s=[{pos:t,path:[]}],a=new Set;for(a.add(`${t.x},${t.y}`);s.length>0;){const{pos:n,path:r}=s.shift();if(n.x===e.x&&n.y===e.y)return r;const l=this.getNeighbors(n);for(const c of l){const d=`${c.x},${c.y}`;this.isValid(c)&&i[c.x][c.y]&&!a.has(d)&&(a.add(d),s.push({pos:c,path:[...r,c]}))}}return null}getValidMoves(t,e){return this.getNeighbors(t).filter(s=>this.isValid(s)&&e[s.x][s.y])}getNeighbors(t){return[{x:t.x,y:t.y-1},{x:t.x,y:t.y+1},{x:t.x-1,y:t.y},{x:t.x+1,y:t.y}]}isValid(t){return t.x>=0&&t.x<this.gridWidth&&t.y>=0&&t.y<this.gridHeight}getDirection(t,e){return e.x>t.x?"RIGHT":e.x<t.x?"LEFT":e.y>t.y?"DOWN":(e.y<t.y,"UP")}}const ct=50,lt=100,dt=50;class pt{x;y;type;duration;direction;gridWidth;gridHeight;constructor(t,e,i){this.x=t.position.x,this.y=t.position.y,this.type=t.type,this.duration=t.type==="temporary"?t.duration??ct:-1,this.direction=t.direction??{x:0,y:0},this.gridWidth=e,this.gridHeight=i}update(){if(this.type==="temporary")return this.duration--,this.duration<=0;if(this.type==="moving"){const t=this.x+this.direction.x,e=this.y+this.direction.y;t<0||t>=this.gridWidth?this.direction.x=-this.direction.x:this.x=t,e<0||e>=this.gridHeight?this.direction.y=-this.direction.y:this.y=e}return!1}get position(){return{x:this.x,y:this.y}}}class q{obstacles=[];gridWidth;gridHeight;lastSpawnScore=0;spawnThreshold=100;rng=null;constructor(t,e){this.gridWidth=t,this.gridHeight=e}random(){return this.rng?this.rng.random():Math.random()}randomInt(t){return this.rng?this.rng.randomInt(t):Math.floor(Math.random()*t)}setRng(t){this.rng=t}reset(){this.obstacles=[],this.lastSpawnScore=0}update(){this.obstacles=this.obstacles.filter(t=>!t.update())}checkSpawn(t,e,i){const s=Math.floor(t/this.spawnThreshold)*this.spawnThreshold;s>this.lastSpawnScore&&t>=this.spawnThreshold&&(this.spawnObstacles(e,i),this.lastSpawnScore=s)}spawnObstacles(t,e){const i=Math.floor(this.lastSpawnScore/this.spawnThreshold)+1,s=Math.min(i,5);for(let a=0;a<s;a++){const n=this.findValidPosition(t,e);if(n){const r=this.selectObstacleType(i),l={type:r,position:n,duration:r==="temporary"?lt+this.randomInt(dt):void 0,direction:r==="moving"?this.getRandomDirection():void 0};this.obstacles.push(new pt(l,this.gridWidth,this.gridHeight))}}}selectObstacleType(t){const e=this.random();return t<2?"static":t<4?e<.7?"static":"temporary":e<.5?"static":e<.8?"temporary":"moving"}getRandomDirection(){const t=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];return t[this.randomInt(t.length)]}findValidPosition(t,e){for(let s=0;s<100;s++){const a=this.randomInt(this.gridWidth),n=this.randomInt(this.gridHeight);if(!this.isPositionOccupied({x:a,y:n},t,e))return{x:a,y:n}}return null}isPositionOccupied(t,e,i){return!!(e.some(s=>s.x===t.x&&s.y===t.y)||i.x===t.x&&i.y===t.y||this.obstacles.some(s=>s.x===t.x&&s.y===t.y))}checkCollision(t){return this.obstacles.some(e=>e.x===t.x&&e.y===t.y)}getObstaclePositions(){return this.obstacles.map(t=>t.position)}getObstacles(){return[...this.obstacles]}get count(){return this.obstacles.length}}const S={dark:{canvasBg:"#010409",gridColor:"#21262d",snakeHeadStart:"#ffffff",snakeHeadEnd:"#6366f1",snakeBodyStart:"#6366f1",snakeBodyEnd:"#ec4899",foodColor:"#238636",foodGlow:"#238636",obstacleStatic:"#ff6b6b",obstacleMoving:"#ffd93d",obstacleTemporary:"#6bcfff"},light:{canvasBg:"#edf2ff",gridColor:"#d3d9f5",snakeHeadStart:"#312e81",snakeHeadEnd:"#6366f1",snakeBodyStart:"#8b5cf6",snakeBodyEnd:"#f472b6",foodColor:"#16a34a",foodGlow:"#22c55e",obstacleStatic:"#dc2626",obstacleMoving:"#d97706",obstacleTemporary:"#0284c7"},green:{canvasBg:"#0b2f26",gridColor:"#184035",snakeHeadStart:"#d1fae5",snakeHeadEnd:"#10b981",snakeBodyStart:"#22c55e",snakeBodyEnd:"#166534",foodColor:"#bef264",foodGlow:"#a3e635",obstacleStatic:"#ef4444",obstacleMoving:"#f59e0b",obstacleTemporary:"#38bdf8"},red:{canvasBg:"#1a0a0a",gridColor:"#3d1515",snakeHeadStart:"#fef2f2",snakeHeadEnd:"#ef4444",snakeBodyStart:"#dc2626",snakeBodyEnd:"#7f1d1d",foodColor:"#fbbf24",foodGlow:"#f59e0b",obstacleStatic:"#3b82f6",obstacleMoving:"#22c55e",obstacleTemporary:"#a855f7"},blue:{canvasBg:"#0a1628",gridColor:"#1e3a5f",snakeHeadStart:"#e0f2fe",snakeHeadEnd:"#3b82f6",snakeBodyStart:"#60a5fa",snakeBodyEnd:"#1e40af",foodColor:"#fbbf24",foodGlow:"#f59e0b",obstacleStatic:"#ef4444",obstacleMoving:"#22c55e",obstacleTemporary:"#e879f9"},purple:{canvasBg:"#1a0a2e",gridColor:"#2d1b4e",snakeHeadStart:"#f3e8ff",snakeHeadEnd:"#a855f7",snakeBodyStart:"#c084fc",snakeBodyEnd:"#6b21a8",foodColor:"#fbbf24",foodGlow:"#f59e0b",obstacleStatic:"#ef4444",obstacleMoving:"#22c55e",obstacleTemporary:"#38bdf8"}},H="dark";class gt{ctx;enabled=!0;constructor(){try{this.ctx=new(window.AudioContext||window.webkitAudioContext)}catch{console.warn("Web Audio API not supported"),this.enabled=!1}}play(t){if(!this.enabled)return;this.ctx.state==="suspended"&&this.ctx.resume();const e=this.ctx.createOscillator(),i=this.ctx.createGain();e.connect(i),i.connect(this.ctx.destination),t==="eat"?(e.type="sine",e.frequency.setValueAtTime(600,this.ctx.currentTime),e.frequency.exponentialRampToValueAtTime(1200,this.ctx.currentTime+.1),i.gain.setValueAtTime(.3,this.ctx.currentTime),i.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.1),e.start(),e.stop(this.ctx.currentTime+.1)):t==="die"?(e.type="sawtooth",e.frequency.setValueAtTime(200,this.ctx.currentTime),e.frequency.exponentialRampToValueAtTime(50,this.ctx.currentTime+.5),i.gain.setValueAtTime(.3,this.ctx.currentTime),i.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.5),e.start(),e.stop(this.ctx.currentTime+.5)):t==="powerup"&&(e.type="sine",e.frequency.setValueAtTime(523,this.ctx.currentTime),e.frequency.setValueAtTime(659,this.ctx.currentTime+.08),e.frequency.setValueAtTime(784,this.ctx.currentTime+.16),e.frequency.setValueAtTime(1047,this.ctx.currentTime+.24),i.gain.setValueAtTime(.35,this.ctx.currentTime),i.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.35),e.start(),e.stop(this.ctx.currentTime+.35))}}const Y={up:{x:0,y:-1},down:{x:0,y:1},left:{x:-1,y:0},right:{x:1,y:0}},ut={"0,-1":"up","0,1":"down","-1,0":"left","1,0":"right"};class yt{inputs=[];themeChanges=[];currentFrame=0;seed=0;gridWidth=0;gridHeight=0;initialSnake=[];initialDirection={x:1,y:0};finalScore=0;timestamp=0;speedPercent=75;theme="dark";isRecording=!1;startRecording(t,e,i,s,a,n,r="dark"){this.inputs=[],this.themeChanges=[],this.currentFrame=0,this.seed=t,this.gridWidth=e,this.gridHeight=i,this.initialSnake=s.map(l=>({...l})),this.initialDirection={...a},this.speedPercent=n,this.theme=r,this.timestamp=Date.now(),this.isRecording=!0}recordInput(t){if(!this.isRecording)return;const e=`${t.x},${t.y}`,i=ut[e];i&&this.inputs.push({frame:this.currentFrame,direction:i})}recordThemeChange(t){this.isRecording&&this.themeChanges.push({frame:this.currentFrame,theme:t})}advanceFrame(){this.isRecording&&this.currentFrame++}stopRecording(t){return this.isRecording=!1,this.finalScore=t,{version:1,seed:this.seed,gridWidth:this.gridWidth,gridHeight:this.gridHeight,initialSnake:this.initialSnake,initialDirection:this.initialDirection,inputs:[...this.inputs],finalScore:this.finalScore,timestamp:this.timestamp,speedPercent:this.speedPercent,theme:this.theme,themeChanges:[...this.themeChanges]}}getIsRecording(){return this.isRecording}getCurrentFrame(){return this.currentFrame}}class ft{replayData=null;currentFrame=0;inputIndex=0;themeChangeIndex=0;isPlaying=!1;isPaused=!1;speed=1;onInputCallback=null;onThemeChangeCallback=null;onCompleteCallback=null;loadReplay(t){this.replayData=t,this.currentFrame=0,this.inputIndex=0,this.themeChangeIndex=0,this.isPlaying=!1,this.isPaused=!1,this.speed=1}startPlayback(t,e,i){if(!this.replayData){console.warn("[PLAYBACK] startPlayback called but no replayData!");return}this.onInputCallback=t,this.onCompleteCallback=e,this.onThemeChangeCallback=i??null,this.currentFrame=0,this.inputIndex=0,this.themeChangeIndex=0,this.isPlaying=!0,this.isPaused=!1}processFrame(){if(!this.replayData||!this.isPlaying||this.isPaused)return null;let t=null;if(this.replayData.themeChanges)for(;this.themeChangeIndex<this.replayData.themeChanges.length&&this.replayData.themeChanges[this.themeChangeIndex].frame===this.currentFrame;){const e=this.replayData.themeChanges[this.themeChangeIndex];this.onThemeChangeCallback&&this.onThemeChangeCallback(e.theme),this.themeChangeIndex++}for(;this.inputIndex<this.replayData.inputs.length&&this.replayData.inputs[this.inputIndex].frame===this.currentFrame;){const e=this.replayData.inputs[this.inputIndex],i=Y[e.direction];this.onInputCallback&&i&&(this.onInputCallback(i),t=i),this.inputIndex++}return t}advanceFrame(){!this.isPlaying||this.isPaused||this.currentFrame++}checkComplete(){return this.replayData?this.inputIndex>=this.replayData.inputs.length:!0}togglePause(){this.isPaused=!this.isPaused}setSpeed(t){this.speed=t}getSpeed(){return this.speed}skipToEnd(){if(!(!this.replayData||!this.isPlaying)){if(this.replayData.themeChanges)for(;this.themeChangeIndex<this.replayData.themeChanges.length;){const t=this.replayData.themeChanges[this.themeChangeIndex];this.onThemeChangeCallback&&this.onThemeChangeCallback(t.theme),this.themeChangeIndex++}for(;this.inputIndex<this.replayData.inputs.length;){const t=this.replayData.inputs[this.inputIndex],e=Y[t.direction];this.onInputCallback&&e&&this.onInputCallback(e),this.inputIndex++}this.isPlaying=!1,this.onCompleteCallback&&this.onCompleteCallback()}}stopPlayback(){this.isPlaying=!1,this.isPaused=!1,this.currentFrame=0,this.inputIndex=0,this.themeChangeIndex=0}getIsPlaying(){return this.isPlaying}getIsPaused(){return this.isPaused}getReplayData(){return this.replayData}getCurrentFrame(){return this.currentFrame}getTotalFrames(){return!this.replayData||this.replayData.inputs.length===0?0:this.replayData.inputs[this.replayData.inputs.length-1].frame+100}}class g{static LAST_REPLAY_KEY="vibe-snake-last-replay";static HIGH_SCORE_REPLAY_KEY="vibe-snake-high-score-replay";static REPLAY_HISTORY_KEY="vibe-snake-replay-history";static saveLastReplay(t){if(!(typeof localStorage>"u"))try{localStorage.setItem(this.LAST_REPLAY_KEY,JSON.stringify(t))}catch{console.warn("Failed to save last replay")}}static loadLastReplay(){if(typeof localStorage>"u")return null;try{const t=localStorage.getItem(this.LAST_REPLAY_KEY);return t?JSON.parse(t):null}catch{return null}}static saveHighScoreReplay(t){if(typeof localStorage>"u")return!1;try{const e=this.loadHighScoreReplay();return e&&e.finalScore>=t.finalScore?!1:(localStorage.setItem(this.HIGH_SCORE_REPLAY_KEY,JSON.stringify(t)),!0)}catch{return console.warn("Failed to save high score replay"),!1}}static loadHighScoreReplay(){if(typeof localStorage>"u")return null;try{const t=localStorage.getItem(this.HIGH_SCORE_REPLAY_KEY);return t?JSON.parse(t):null}catch{return null}}static saveReplayToHistory(t){if(!(typeof localStorage>"u"))try{const e=this.loadReplayHistory(),i=[t,...e].slice(0,50);localStorage.setItem(this.REPLAY_HISTORY_KEY,JSON.stringify(i))}catch{console.warn("Failed to save replay history")}}static loadReplayHistory(){if(typeof localStorage>"u")return[];try{const t=localStorage.getItem(this.REPLAY_HISTORY_KEY);if(!t)return[];const e=JSON.parse(t);return Array.isArray(e)?e:[]}catch{return[]}}static deleteReplayFromHistory(t){if(!(typeof localStorage>"u"))try{const e=this.loadReplayHistory();t>=0&&t<e.length&&(e.splice(t,1),localStorage.setItem(this.REPLAY_HISTORY_KEY,JSON.stringify(e)))}catch{console.warn("Failed to delete replay from history")}}static clearReplayHistory(){if(!(typeof localStorage>"u"))try{localStorage.removeItem(this.REPLAY_HISTORY_KEY)}catch{console.warn("Failed to clear replay history")}}static exportReplay(t){const e=JSON.stringify(t);return btoa(encodeURIComponent(e))}static importReplay(t){try{const e=decodeURIComponent(atob(t)),i=JSON.parse(e);return typeof i.version!="number"||typeof i.seed!="number"||!Array.isArray(i.inputs)||!Array.isArray(i.initialSnake)?null:i}catch{return null}}}class mt{renderer;snake;food;specialFood;autoPilot;obstacleManager;audio;lastTime=0;baseDropInterval=100;dropCounter=0;speedPercent=75;isRunning=!1;isPaused=!1;isAuto=!1;score=0;highScore=0;highScoreKey="vibe-snake-high-score";gridSize=20;gridWidth;gridHeight;currentTheme=H;activePowerUp=null;replayRecorder;replayPlayer;rng=null;isReplayMode=!1;currentSeed=0;constructor(t){this.renderer=new ht(t,this.gridSize,S[this.currentTheme]),this.audio=new gt,this.gridWidth=t.width/this.gridSize,this.gridHeight=t.height/this.gridSize,this.highScore=this.loadHighScore(),this.updateHighScoreDisplay(),this.replayRecorder=new yt,this.replayPlayer=new ft,this.bindEvents(),this.reset()}setTheme(t){this.currentTheme=t,this.renderer.setTheme(S[t]),this.draw(),this.isRunning&&!this.isReplayMode&&this.replayRecorder.getIsRecording()&&this.replayRecorder.recordThemeChange(t)}setSpeed(t){const e=Math.max(0,Math.min(100,t));this.speedPercent=e;const i=50,s=250;this.baseDropInterval=s-e/100*(s-i)}setThickness(t){const e=Math.max(1,Math.min(5,t));this.renderer.setThickness(e),this.draw()}bindEvents(){window.addEventListener("keydown",t=>{const e=new Set(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"]);if(t.key==="p"||t.key==="P"){(this.isRunning||this.isPaused)&&this.togglePause();return}if(!this.isReplayMode){if(e.has(t.key)){if(t.preventDefault(),!this.isRunning||this.isPaused)return}else if(!this.isRunning||this.isPaused)return;switch(t.key){case"ArrowUp":this.handleDirectionInput({x:0,y:-1});break;case"ArrowDown":this.handleDirectionInput({x:0,y:1});break;case"ArrowLeft":this.handleDirectionInput({x:-1,y:0});break;case"ArrowRight":this.handleDirectionInput({x:1,y:0});break;case"a":case"A":this.toggleAuto();break}}})}handleDirectionInput(t){this.snake.setDirection(t)&&!this.isReplayMode&&!this.isAuto&&this.replayRecorder.recordInput(t)}start(){this.stopReplay(),this.reset(),this.isRunning=!0,this.isPaused=!1,this.updatePauseBadge(),this.updateReplayBadge(),this.lastTime=performance.now(),this.dropCounter=0,this.replayRecorder.startRecording(this.currentSeed,this.gridWidth,this.gridHeight,this.snake.segments,this.snake.direction,this.speedPercent,this.currentTheme),requestAnimationFrame(t=>this.update(t))}reset(){this.score=0,this.updateScore(),this.currentSeed=E.generateSeed(),this.rng=new E(this.currentSeed),this.snake=new z(this.gridWidth,this.gridHeight),this.food=new G(this.gridWidth,this.gridHeight),this.food.setRng(this.rng),this.obstacleManager=new q(this.gridWidth,this.gridHeight),this.obstacleManager.setRng(this.rng),this.food.respawn(this.snake.segments,this.obstacleManager.getObstaclePositions()),this.specialFood=new $(this.gridWidth,this.gridHeight),this.specialFood.setRng(this.rng),this.autoPilot=new K(this.snake,this.food,this.gridWidth,this.gridHeight,this.specialFood),this.activePowerUp=null,this.updatePowerUpHUD(),this.draw()}toggleAuto(){this.isAuto=!this.isAuto;const t=document.getElementById("auto-badge");t&&(this.isAuto?t.classList.add("active"):t.classList.remove("active"))}togglePause(){!this.isRunning&&!this.isPaused||(this.isPaused=!this.isPaused,this.updatePauseBadge(),this.isReplayMode&&this.replayPlayer.togglePause(),this.isPaused||(this.lastTime=performance.now(),this.dropCounter=0,requestAnimationFrame(t=>this.update(t))))}updatePauseBadge(){const t=document.getElementById("pause-badge");t&&(this.isPaused?t.classList.add("active"):t.classList.remove("active"))}updateReplayBadge(){const t=document.getElementById("replay-badge");t&&(this.isReplayMode?t.classList.add("active"):t.classList.remove("active"))}update(t=0){if(!this.isRunning||this.isPaused)return;const e=Math.min(t-this.lastTime,100);this.lastTime=t,this.dropCounter+=e;let i=Math.max(50,this.baseDropInterval-this.score*2);this.activePowerUp&&(this.activePowerUp.type==="speed_boost"?i=i*.6:this.activePowerUp.type==="slow_motion"&&(i=i*1.5)),this.isReplayMode&&(i=i/this.replayPlayer.getSpeed()),this.specialFood.update(t),this.updateActivePowerUp(t),this.dropCounter>i&&(this.step(),this.dropCounter=0),this.draw(),requestAnimationFrame(s=>this.update(s))}updateActivePowerUp(t){if(!this.activePowerUp)return;t-this.activePowerUp.startTime>=this.activePowerUp.duration?(this.activePowerUp=null,this.updatePowerUpHUD()):this.updatePowerUpHUD()}updatePowerUpHUD(){const t=document.getElementById("powerup-indicator");if(!t)return;if(!this.activePowerUp){t.classList.remove("active"),t.innerHTML="";return}const e=b[this.activePowerUp.type],i=performance.now(),s=Math.max(0,this.activePowerUp.duration-(i-this.activePowerUp.startTime)),a=Math.ceil(s/1e3);t.classList.add("active"),t.innerHTML=`
            <span class="powerup-name" style="color: ${e.color}">${e.displayName}</span>
            <span class="powerup-timer">${a}s</span>
        `}step(){if(this.isReplayMode)this.replayPlayer.processFrame(),this.replayPlayer.advanceFrame();else{if(this.isAuto){this.autoPilot.setObstacles(this.obstacleManager.getObstaclePositions());const e=this.autoPilot.getNextMove();e&&this.snake.setDirection(e)&&this.replayRecorder.recordInput(e)}this.replayRecorder.advanceFrame()}this.obstacleManager.update(),this.isAuto||this.autoPilot.setObstacles(this.obstacleManager.getObstaclePositions()),this.snake.move();const t=this.activePowerUp?.type==="invincibility";if(this.snake.checkCollision()){if(!t){this.isReplayMode?this.onReplayComplete():this.gameOver();return}this.handleWrapAround()}if(this.obstacleManager.checkCollision(this.snake.head)){this.isReplayMode?this.onReplayComplete():this.gameOver();return}this.snake.head.x===this.food.x&&this.snake.head.y===this.food.y&&(this.snake.grow(),this.food.respawn(this.snake.segments,this.obstacleManager.getObstaclePositions()),this.score+=10,this.updateScore(),this.isReplayMode||this.tryUpdateHighScore(),this.audio.play("eat"),this.specialFood.shouldSpawn()&&this.specialFood.spawn(this.snake.segments,this.food.x,this.food.y),this.obstacleManager.checkSpawn(this.score,this.snake.segments,{x:this.food.x,y:this.food.y})),this.specialFood.isActive&&this.snake.head.x===this.specialFood.x&&this.snake.head.y===this.specialFood.y&&this.collectSpecialFood()}handleWrapAround(){const t=this.snake.head;t.x<0?t.x=this.gridWidth-1:t.x>=this.gridWidth&&(t.x=0),t.y<0?t.y=this.gridHeight-1:t.y>=this.gridHeight&&(t.y=0)}collectSpecialFood(){const t=this.specialFood.getConfig();this.score+=t.pointsBonus,this.updateScore(),this.isReplayMode||this.tryUpdateHighScore(),this.audio.play("powerup"),t.duration>0&&(this.activePowerUp={type:t.type,startTime:performance.now(),duration:t.duration},this.updatePowerUpHUD()),this.specialFood.despawn()}draw(){this.renderer.clear(),this.obstacleManager&&this.renderer.drawObstacles(this.obstacleManager.getObstacles()),this.food&&this.renderer.drawFood(this.food.x,this.food.y),this.specialFood?.isActive&&this.renderer.drawSpecialFood(this.specialFood.x,this.specialFood.y,this.specialFood.type,this.specialFood.animationPhase);const t=this.activePowerUp?.type==="invincibility";this.snake&&this.renderer.drawSnake(this.snake.segments,t)}updateScore(){const t=document.getElementById("score");t&&(t.innerText=this.score.toString())}loadHighScore(){if(typeof localStorage>"u")return 0;const t=localStorage.getItem(this.highScoreKey);if(!t)return 0;const e=parseInt(t,10);return Number.isNaN(e)?0:e}persistHighScore(){typeof localStorage>"u"||localStorage.setItem(this.highScoreKey,this.highScore.toString())}updateHighScoreDisplay(){const t=document.getElementById("high-score");t&&(t.innerText=this.highScore.toString())}tryUpdateHighScore(){this.score<=this.highScore||(this.highScore=this.score,this.persistHighScore(),this.updateHighScoreDisplay())}gameOver(){this.isRunning=!1,this.audio.play("die"),this.activePowerUp=null,this.updatePowerUpHUD();const t=this.replayRecorder.stopRecording(this.score);console.log(`[RECORD] Game over. Recorded ${t.inputs.length} inputs:`,t.inputs),g.saveLastReplay(t),g.saveReplayToHistory(t);const e=g.saveHighScoreReplay(t);if(this.updateWatchBestReplayButton(),this.isAuto){setTimeout(()=>{this.start()},1e3);return}const i=document.getElementById("game-over-screen"),s=document.getElementById("final-score"),a=document.getElementById("watch-replay-btn"),n=document.getElementById("new-high-score-label");i&&s&&(s.innerText=this.score.toString(),i.classList.remove("hidden")),a&&a.classList.remove("hidden"),n&&(e&&this.score>0?n.classList.remove("hidden"):n.classList.add("hidden"))}startReplay(t){this.stopReplay();const e=document.getElementById("start-screen"),i=document.getElementById("game-over-screen");e?.classList.add("hidden"),i?.classList.add("hidden"),this.isReplayMode=!0,this.isRunning=!0,this.isPaused=!1,this.score=0,this.updateScore(),this.currentSeed=t.seed,this.rng=new E(this.currentSeed),this.snake=new z(this.gridWidth,this.gridHeight),this.snake.segments=t.initialSnake.map(s=>({...s})),this.snake.direction={...t.initialDirection},this.snake.nextDirection={...t.initialDirection},this.food=new G(this.gridWidth,this.gridHeight),this.food.setRng(this.rng),this.obstacleManager=new q(this.gridWidth,this.gridHeight),this.obstacleManager.setRng(this.rng),this.food.respawn(this.snake.segments,this.obstacleManager.getObstaclePositions()),this.specialFood=new $(this.gridWidth,this.gridHeight),this.specialFood.setRng(this.rng),this.autoPilot=new K(this.snake,this.food,this.gridWidth,this.gridHeight,this.specialFood),this.activePowerUp=null,this.updatePowerUpHUD(),this.setSpeed(t.speedPercent),t.theme&&this.applyThemeForReplay(t.theme),this.replayPlayer.loadReplay(t),this.replayPlayer.startPlayback(s=>this.snake.setDirection(s),()=>this.onReplayComplete(),s=>this.applyThemeForReplay(s)),this.updatePauseBadge(),this.updateReplayBadge(),this.showReplayControls(!0),this.lastTime=performance.now(),this.dropCounter=0,requestAnimationFrame(s=>this.update(s))}applyThemeForReplay(t){this.currentTheme=t,this.renderer.setTheme(S[t]);const e=document.getElementById("theme-select");e&&(e.value=t),document.documentElement.setAttribute("data-theme",t),this.draw()}watchLastReplay(){const t=g.loadLastReplay();t&&this.startReplay(t)}watchHighScoreReplay(){const t=g.loadHighScoreReplay();t&&this.startReplay(t)}stopReplay(){this.isReplayMode&&(this.replayPlayer.stopPlayback(),this.isReplayMode=!1,this.isRunning=!1,this.showReplayControls(!1),this.updateReplayBadge())}onReplayComplete(){this.isRunning=!1,this.audio.play("die");const t=document.getElementById("replay-complete-screen"),e=document.getElementById("replay-final-score");if(t){if(e){const i=this.replayPlayer.getReplayData();e.innerText=i?.finalScore.toString()??this.score.toString()}t.classList.remove("hidden")}this.showReplayControls(!1)}setReplaySpeed(t){this.replayPlayer.setSpeed(t),this.updateSpeedButtons(t)}toggleReplayPause(){this.isReplayMode&&this.togglePause()}skipReplayToEnd(){this.isReplayMode&&this.replayPlayer.skipToEnd()}showReplayControls(t){const e=document.getElementById("replay-controls");e&&(t?e.classList.remove("hidden"):e.classList.add("hidden"))}updateSpeedButtons(t){[.5,1,2].forEach(i=>{const s=document.getElementById(`speed-${i}x-btn`);s&&(i===t?s.classList.add("active"):s.classList.remove("active"))})}updateWatchBestReplayButton(){const t=document.getElementById("watch-best-replay-btn");t&&(g.loadHighScoreReplay()!==null?t.classList.remove("hidden"):t.classList.add("hidden"))}getIsReplayMode(){return this.isReplayMode}getReplayHistory(){return g.loadReplayHistory()}deleteReplayFromHistory(t){g.deleteReplayFromHistory(t)}clearReplayHistory(){g.clearReplayHistory()}exportLastReplay(){const t=g.loadLastReplay();return t?g.exportReplay(t):null}exportHighScoreReplay(){const t=g.loadHighScoreReplay();return t?g.exportReplay(t):null}importAndPlayReplay(t){const e=g.importReplay(t);return e?(this.startReplay(e),!0):!1}}document.addEventListener("DOMContentLoaded",()=>{const p=document.getElementById("gameCanvas"),t=new mt(p),e=document.getElementById("theme-select"),i=document.getElementById("speed-slider"),s=document.getElementById("thickness-slider"),a=document.getElementById("start-btn"),n=document.getElementById("restart-btn"),r=document.getElementById("start-screen"),l=document.getElementById("game-over-screen"),c=document.getElementById("watch-replay-btn"),d=document.getElementById("watch-best-replay-btn"),u=document.getElementById("replay-history-panel"),m=document.getElementById("replay-history-list"),L=document.getElementById("replay-history-close-btn"),J=document.getElementById("clear-all-history-btn"),R=document.getElementById("replay-history-empty"),j=document.getElementById("replay-pause-btn"),w=document.getElementById("speed-0.5x-btn"),T=document.getElementById("speed-1x-btn"),v=document.getElementById("speed-2x-btn"),Q=document.getElementById("skip-end-btn"),Z=document.getElementById("stop-replay-btn"),M=document.getElementById("replay-complete-screen"),X=document.getElementById("replay-play-again-btn"),tt=document.getElementById("replay-watch-again-btn"),B=h=>{const o=S[h]?h:H;document.documentElement.setAttribute("data-theme",o),localStorage.setItem("vibe-snake-theme",o),t.setTheme(o),e&&(e.value=o)},A=h=>{const o=Math.max(0,Math.min(100,h));t.setSpeed(o),localStorage.setItem("vibe-snake-speed",o.toString())},F=h=>{const o=Math.max(1,Math.min(5,h));t.setThickness(o),localStorage.setItem("vibe-snake-thickness",o.toString())},et=localStorage.getItem("vibe-snake-theme")||H;B(et);const D=localStorage.getItem("vibe-snake-speed"),O=D?parseInt(D,10):75;A(O),i&&(i.value=O.toString());const _=localStorage.getItem("vibe-snake-thickness"),W=_?parseInt(_,10):3;F(W),s&&(s.value=W.toString()),t.updateWatchBestReplayButton(),a?.addEventListener("click",()=>{r?.classList.add("hidden"),t.start()}),n?.addEventListener("click",()=>{l?.classList.add("hidden"),t.start()}),e?.addEventListener("change",h=>{const o=h.target;B(o.value)}),i?.addEventListener("input",h=>{const o=h.target;A(parseInt(o.value,10))}),s?.addEventListener("input",h=>{const o=h.target;F(parseInt(o.value,10))}),c?.addEventListener("click",()=>{l?.classList.add("hidden"),t.watchLastReplay()}),d?.addEventListener("click",()=>{r?.classList.add("hidden"),t.watchHighScoreReplay()}),j?.addEventListener("click",()=>{t.toggleReplayPause()});const P=h=>{t.setReplaySpeed(h),w?.classList.remove("active"),T?.classList.remove("active"),v?.classList.remove("active"),h===.5?w?.classList.add("active"):h===1?T?.classList.add("active"):h===2&&v?.classList.add("active")};w?.addEventListener("click",()=>P(.5)),T?.addEventListener("click",()=>P(1)),v?.addEventListener("click",()=>P(2)),Q?.addEventListener("click",()=>{t.skipReplayToEnd()}),Z?.addEventListener("click",()=>{t.stopReplay(),r?.classList.remove("hidden")}),X?.addEventListener("click",()=>{M?.classList.add("hidden"),t.start()}),tt?.addEventListener("click",()=>{M?.classList.add("hidden"),t.watchLastReplay()});const it=(h,o)=>{const y=new Date(h),f=y.toLocaleDateString(void 0,{month:"short",day:"numeric"}),x=y.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"});return`Score ${o} ‚Ä¢ ${f} ${x}`},I=()=>{if(!m||!R)return;const h=t.getReplayHistory();if(m.innerHTML="",!h.length){R.classList.remove("hidden");return}R.classList.add("hidden"),h.forEach((o,y)=>{const f=document.createElement("li");f.classList.add("history-item");const x=o.theme?` ‚Ä¢ ${o.theme}`:"";f.innerHTML=`
        <div class="history-item__meta">
          <span class="history-item__title">${it(o.timestamp,o.finalScore)}</span>
          <span class="history-item__details">Grid ${o.gridWidth}x${o.gridHeight} ‚Ä¢ Speed ${o.speedPercent}%${x}</span>
        </div>
        <div class="history-item__actions">
          <button class="btn btn-small history-play-btn" data-history-index="${y}">Watch</button>
          <button class="icon-btn history-delete-btn" data-delete-index="${y}" title="Delete">üóëÔ∏è</button>
        </div>
      `,m.appendChild(f)})},k=h=>{u&&(h?(I(),u.classList.remove("hidden")):u.classList.add("hidden"))};L?.addEventListener("click",()=>k(!1)),J?.addEventListener("click",()=>{confirm("Clear all replay history?")&&(t.clearReplayHistory(),I())}),document.addEventListener("keydown",h=>{if(h.key==="r"||h.key==="R"){h.preventDefault();const o=u?.classList.contains("hidden")??!0;k(o)}}),m?.addEventListener("click",h=>{const o=h.target,y=o.closest("button[data-delete-index]");if(y){const N=parseInt(y.dataset.deleteIndex??"-1",10);N>=0&&(t.deleteReplayFromHistory(N),I());return}const f=o.closest("button[data-history-index]");if(!f)return;const x=parseInt(f.dataset.historyIndex??"-1",10),U=t.getReplayHistory()[x];U&&(k(!1),t.startReplay(U))})});
